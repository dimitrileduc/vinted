import { PredictionServiceClient, helpers } from '@google-cloud/aiplatform'
import type { InpaintResult } from '../types/pipeline'

const INPAINT_PROMPT = `Clean wooden parquet floor, tidy apartment interior, soft natural daylight from window, neutral white walls, minimalist Vinted seller home aesthetic, natural soft shadows on floor`

export async function inpaintBackground(
  originalBuffer: Buffer,
  maskBuffer: Buffer,
  projectId: string,
  location: string = 'us-central1'
): Promise<InpaintResult> {
  const startTime = Date.now()

  try {
    const client = new PredictionServiceClient({
      apiEndpoint: `${location}-aiplatform.googleapis.com`
    })

    const endpoint = `projects/${projectId}/locations/${location}/publishers/google/models/imagen-3.0-capability-001`

    const originalBase64 = originalBuffer.toString('base64')
    const maskBase64 = maskBuffer.toString('base64')

    // Imagen 3 inpainting with user-provided mask
    const instance = helpers.toValue({
      prompt: INPAINT_PROMPT,
      referenceImages: [
        {
          referenceType: 'REFERENCE_TYPE_RAW',
          referenceId: 1,
          referenceImage: {
            bytesBase64Encoded: originalBase64
          }
        },
        {
          referenceType: 'REFERENCE_TYPE_MASK',
          referenceId: 2,
          referenceImage: {
            bytesBase64Encoded: maskBase64
          },
          maskImageConfig: {
            maskMode: 'MASK_MODE_USER_PROVIDED',
            dilation: 0.01
          }
        }
      ]
    })

    const parameters = helpers.toValue({
      editMode: 'EDIT_MODE_INPAINT_INSERTION',
      editConfig: {
        baseSteps: 75
      },
      sampleCount: 1
    })

    const [response] = await client.predict({
      endpoint,
      instances: [instance!],
      parameters
    })

    const predictions = response.predictions || []
    if (predictions.length === 0) {
      throw new Error('No predictions returned from Imagen 3')
    }

    const prediction = helpers.fromValue(predictions[0])
    const editedBase64 = (prediction as any).bytesBase64Encoded

    if (!editedBase64) {
      throw new Error('No image data in Imagen 3 response')
    }

    const editedBuffer = Buffer.from(editedBase64, 'base64')
    const processingTime = Date.now() - startTime

    return {
      edited_buffer: editedBuffer,
      edited_base64: editedBase64,
      processing_time_ms: processingTime,
      model_version: 'imagen-3.0-capability-001',
      success: true
    }

  } catch (error) {
    const processingTime = Date.now() - startTime
    return {
      edited_buffer: Buffer.alloc(0),
      edited_base64: '',
      processing_time_ms: processingTime,
      model_version: 'imagen-3.0-capability-001',
      success: false,
      error: error instanceof Error ? error.message : 'Unknown error'
    }
  }
}
